<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Block 12 â€” Control de Cobranzas (Febâ€“Jun 2026)</title>
  <style>
    :root{
      --bg:#0b1020; --muted:#8aa0c6; --txt:#e7efff;
      --ok:#1db954; --warn:#f5c542; --bad:#ff4d4d;
      --line:rgba(255,255,255,.10); --shadow:0 14px 40px rgba(0,0,0,.30);
      --radius:18px; --gap:14px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 700px at 20% 0%, #132a66 0%, rgba(19,42,102,0) 60%), var(--bg); color:var(--txt); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;}
    header{position:sticky;top:0;z-index:20;backdrop-filter:blur(10px);background:rgba(11,16,32,.72);border-bottom:1px solid var(--line);}
    .wrap{max-width:1120px;margin:0 auto;padding:14px;}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{font-weight:800;letter-spacing:.2px}
    .pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .pill.ok{color:#bff5d0;border-color:rgba(29,185,84,.35);background:rgba(29,185,84,.08)}
    .pill.bad{color:#ffd0d0;border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.06)}
    .pill.warn{color:#fff0c2;border-color:rgba(245,197,66,.35);background:rgba(245,197,66,.07)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{border:1px solid rgba(255,255,255,.12);background:rgba(28,45,85,.9);color:white;padding:9px 12px;border-radius:12px;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(180deg, rgba(42,101,255,.95) 0%, rgba(32,80,210,.95) 100%);box-shadow:0 10px 26px rgba(0,0,0,.25);}
    button.danger{background:rgba(176,0,32,.9)}
    button:active{transform:translateY(1px)}
    main{padding:12px 0 28px}
    .gridTop{display:grid;grid-template-columns:1.25fr .75fr;gap:var(--gap);align-items:start}
    .card{background:linear-gradient(180deg, rgba(17,26,51,.9) 0%, rgba(10,20,48,.85) 100%);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
    .card h2{margin:0 0 10px 0;font-size:13px;letter-spacing:.12em;text-transform:uppercase;color:#b9c9ff}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(10,20,48,.55);color:var(--txt);outline:none}
    textarea{min-height:44px;resize:vertical}
    .kpis{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{background:rgba(10,20,48,.45);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:12px}
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:24px;font-weight:900;margin-top:6px}
    .kpi .v.small{font-size:20px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .hr{height:1px;background:var(--line);margin:14px 0}
    .svcTop{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-top:8px}
    .svcBar{display:flex;gap:10px;flex-wrap:wrap;align-items:end;margin-top:10px}
    .svcBar .grow{flex:1}
    .svcTable{margin-top:10px;border-top:1px solid var(--line);padding-top:10px}
    .svcItem{display:grid;grid-template-columns:1.2fr .6fr .55fr .7fr 1.2fr .3fr;gap:8px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,.10)}
    .badge{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(10,20,48,.45);font-weight:900;font-size:12px;cursor:pointer;user-select:none;text-transform:uppercase;letter-spacing:.08em}
    .badge.ok{color:#c8ffe0;border-color:rgba(29,185,84,.35);background:rgba(29,185,84,.10)}
    .badge.bad{color:#ffd2d2;border-color:rgba(255,77,77,.35);background:rgba(255,77,77,.08)}
    .badge.warn{color:#fff3c9;border-color:rgba(245,197,66,.35);background:rgba(245,197,66,.08)}
    .bottom{margin-top:var(--gap);display:grid;grid-template-columns:1fr;gap:var(--gap)}
    .floors{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:12px}
    .floorCard{border:1px solid rgba(255,255,255,.10);background:rgba(10,20,48,.45);border-radius:16px;padding:10px;min-height:82px}
    .floorTitle{font-weight:900}
    .floorPend{font-size:12px;margin-top:6px;color:var(--muted);word-break:break-word}
    .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .tableWrap{overflow:auto;border:1px solid rgba(255,255,255,.10);background:rgba(10,20,48,.35);border-radius:16px}
    table{width:100%;border-collapse:collapse;min-width:920px}
    th,td{border-bottom:1px solid rgba(255,255,255,.10);padding:10px;vertical-align:top}
    th{position:sticky;top:0;background:rgba(10,20,48,.9);z-index:3;font-size:12px;color:#b9c9ff;text-align:left}
    td input,td textarea{background:rgba(255,255,255,.04)}
    .mono{font-variant-numeric:tabular-nums}
    .statusTxt{font-weight:900;letter-spacing:.06em}
    .statusTxt.ok{color:#bff5d0} .statusTxt.bad{color:#ffb2b2} .statusTxt.warn{color:#ffe8a3}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,.72);color:white;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:10px 14px;font-weight:800;opacity:0;pointer-events:none;transition:.2s;z-index:999;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .toast.show{opacity:1}
    .smallActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .smallActions button{padding:8px 10px;border-radius:12px}
    @media (max-width:980px){.gridTop{grid-template-columns:1fr}.svcTop{grid-template-columns:1fr 1fr}.floors{grid-template-columns:1fr 1fr}table{min-width:860px}}
    @media (max-width:560px){.svcItem{grid-template-columns:1fr .7fr .7fr 1fr}.svcItem .note,.svcItem .del{grid-column:1/-1}}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div class="title">Block 12 â€” Control de Cobranzas (Febâ€“Jun 2026)</div>
        <div class="pills">
          <span class="pill" id="savePill">Auto-guardado: â€”</span>
          <span class="pill bad" id="dbPill">D1: sin llave</span>
          <span class="pill" id="lastEdit">Ãšltima ediciÃ³n: â€”</span>
        </div>
      </div>
      <div class="actions">
        <button id="btnKey">Configurar llave</button>
        <button id="btnPdf" class="primary">Exportar PDF</button>
        <button id="btnCsv">Exportar CSV</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <section class="gridTop">
      <div class="card">
        <h2>ConfiguraciÃ³n del mes</h2>
        <div class="row">
          <div>
            <label>Mes</label>
            <select id="period">
              <option value="2026-02">Febrero 2026</option>
              <option value="2026-03">Marzo 2026</option>
              <option value="2026-04">Abril 2026</option>
              <option value="2026-05">Mayo 2026</option>
              <option value="2026-06">Junio 2026</option>
            </select>
          </div>
          <div>
            <label>Fecha lÃ­mite</label>
            <input id="deadline" type="date" />
          </div>
          <div>
            <label>Cuota por dpto (S/)</label>
            <input id="fee" type="number" inputmode="decimal" step="0.01" min="0" />
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <div>
            <label>Medio de pago (texto para mostrar)</label>
            <input id="payMedium" placeholder="Ej: PLIN 978 515 968" />
          </div>
          <div>
            <label>Recepciona</label>
            <input id="receiver" placeholder="Ej: William Huatay Villoslada" />
          </div>
        </div>

        <div class="hr"></div>

        <h2>Servicios y gastos del mes</h2>

        <div class="svcTop">
          <div class="kpi"><div class="k">Total servicios</div><div class="v mono" id="svcTotal">S/ 0.00</div></div>
          <div class="kpi"><div class="k">Servicios pagados</div><div class="v mono" id="svcPaid">S/ 0.00</div></div>
          <div class="kpi"><div class="k">Servicios pendientes</div><div class="v mono" id="svcPend">S/ 0.00</div></div>
          <div class="kpi"><div class="k">Cuota sugerida (Total/20)</div><div class="v mono" id="svcFee">S/ 0.00</div></div>
        </div>

        <div class="svcBar">
          <button id="btnUseFee">Usar cuota sugerida</button>
          <label class="tiny" style="display:flex;align-items:center;gap:8px;margin:0;color:var(--muted)">
            <input id="chkApplyAll" type="checkbox" style="width:auto;transform:scale(1.1)" checked />
            Aplicar a los 20 dptos (monto del mes)
          </label>
          <div class="grow"></div>
          <div style="min-width:220px">
            <label class="tiny">Nuevo servicio</label>
            <input id="newSvcName" placeholder="Ej: JardinerÃ­a" />
          </div>
          <div style="width:160px">
            <label class="tiny">Monto (S/)</label>
            <input id="newSvcAmt" type="number" step="0.01" min="0" inputmode="decimal" />
          </div>
          <button id="btnAddSvc">Agregar</button>
        </div>

        <div class="svcTable">
          <div class="tiny muted" style="margin-bottom:6px">Tip: haz click en <b>PAGADO/PENDIENTE</b> para alternar.</div>
          <div id="svcList"></div>
        </div>

      </div>

      <div class="card">
        <h2>Resumen del mes</h2>
        <div class="kpis">
          <div class="kpi">
            <div class="k">Recaudado</div>
            <div class="v mono" id="kpiCollected">S/ 0.00</div>
          </div>
          <div class="kpi">
            <div class="k">Pendiente</div>
            <div class="v mono" id="kpiPending">S/ 0.00</div>
          </div>
          <div class="kpi">
            <div class="k">Al dÃ­a</div>
            <div class="v small mono" id="kpiOnTime">0/20</div>
          </div>
          <div class="kpi">
            <div class="k">Dptos pendientes</div>
            <div class="v small" id="kpiMissingCount">0 dptos</div>
            <div class="tiny muted" id="kpiMissingList" style="margin-top:6px;max-height:120px;overflow:auto"></div>
          </div>
        </div>

        <div class="smallActions">
          <button id="btnMarkPaid">Marcar Pagado (hoy)</button>
          <select id="quickUnit">
            <option value="">Dptoâ€¦</option>
          </select>
          <button id="btnCopyMissing">Copiar pendientes</button>
          <button id="btnCopyMsg">Copiar mensaje por pisos</button>
        </div>

        <div class="hr"></div>
        <h2 class="tiny" style="margin-bottom:8px">Respaldo (por si acaso)</h2>
        <div class="smallActions">
          <button id="btnBackup">Backup JSON</button>
          <button id="btnImport">Importar JSON</button>
          <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        </div>
        <div class="tiny muted" style="margin-top:10px">
          Regla de oro: si algo sale raro, exporta el JSON. El condominio es duro, pero el navegador mÃ¡s ðŸ˜„
        </div>
      </div>
    </section>

    <section class="bottom">
      <div class="card">
        <div>
          <h2 style="margin:0 0 6px 0">SemÃ¡foro por piso (4 dptos por piso)</h2>
          <div class="tiny muted">Rojo: pendientes, amarillo: parcial, verde: todos al dÃ­a.</div>
        </div>
        <div class="floors" id="floors"></div>
      </div>

      <div class="card">
        <h2>Detalle por departamento</h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Dpto</th><th>Piso</th><th>Monto (S/)</th><th>Pagado (S/)</th><th>Saldo</th><th>Fecha</th><th>Medio</th><th>OperaciÃ³n</th><th>Nota</th><th>Estado</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
/* ====== Datos base ====== */
const UNITS = (() => {
  const arr = [];
  for (let floor=1; floor<=5; floor++){
    for (let i=1; i<=4; i++){
      arr.push({unit: `${floor}0${i}`, floor});
    }
  }
  return arr;
})();
const DEFAULTS = {
  "2026-02": { deadline: "2026-02-19", fee: 114.82, payMedium:"PLIN 978 515 968", receiver:"William Huatay Villoslada" },
  "2026-03": { deadline: "2026-03-19", fee: 0, payMedium:"", receiver:"" },
  "2026-04": { deadline: "2026-04-19", fee: 0, payMedium:"", receiver:"" },
  "2026-05": { deadline: "2026-05-19", fee: 0, payMedium:"", receiver:"" },
  "2026-06": { deadline: "2026-06-19", fee: 0, payMedium:"", receiver:"" },
};

/* ====== Servicios ====== */
function defaultServices(){
  return [
    {id:"agua", name:"Agua", amount:0, paid:false, paid_date:"", note:"", locked:true},
    {id:"luz", name:"Luz", amount:0, paid:false, paid_date:"", note:"", locked:true},
    {id:"seguridad", name:"Seguridad", amount:0, paid:false, paid_date:"", note:"", locked:true},
    {id:"limpieza", name:"Limpieza", amount:0, paid:false, paid_date:"", note:"", locked:true},
  ];
}
function ensureServices(meta){
  if (!meta.services || !Array.isArray(meta.services.items)){
    meta.services = { items: defaultServices() };
    return;
  }
  const base = defaultServices();
  const byId = Object.fromEntries(meta.services.items.map(s=>[s.id,s]));
  for (const b of base){
    if (!byId[b.id]) meta.services.items.push(b);
    else byId[b.id].locked = true;
  }
}
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

/* ====== Utilidades ====== */
const el = (id)=>document.getElementById(id);
const toastEl = el("toast");
const savePill = el("savePill");
const dbPill = el("dbPill");
const lastEditEl = el("lastEdit");

const money = (n)=> `S/ ${Number(n||0).toFixed(2)}`;
const toNum = (v)=> { const n = Number(v); return Number.isFinite(n) ? n : 0; };
function escapeHtml(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function showToast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toastEl.classList.remove("show"), 2200);
}
function keyLocal(period){ return `block12:cobranzas:${period}`; }
function todayISO(){ const d=new Date(); const z=(x)=>String(x).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function periodLabel(p){
  const [y,m]=p.split("-");
  const names={"02":"Febrero","03":"Marzo","04":"Abril","05":"Mayo","06":"Junio"};
  return `${names[m]||m} ${y}`;
}

/* ====== Estado ====== */
let state = null;
let autosaveTimer = null;
let cloudTimer = null;

/* ====== D1 (Pages Functions) ====== */
function getApiBase(){ return location.origin; }
function getAppKey(){ return localStorage.getItem("block12:appkey") || ""; }
function setAppKey(k){
  if (!k) localStorage.removeItem("block12:appkey");
  else localStorage.setItem("block12:appkey", k);
  updateDbPill();
}
function updateDbPill(extra){
  const key = getAppKey();
  if (!key){
    dbPill.className = "pill bad";
    dbPill.textContent = "D1: sin llave";
    return;
  }
  dbPill.className = "pill ok";
  dbPill.textContent = extra ? `D1: ${extra}` : "D1: conectado";
}
async function cloudGet(period){
  const key = getAppKey();
  if (!key) return null;
  const r = await fetch(`${getApiBase()}/api/state?period=${encodeURIComponent(period)}`, { headers: {"X-App-Key": key} });
  if (!r.ok) throw new Error(`D1 GET ${r.status}`);
  return await r.json();
}
async function cloudPut(payload){
  const key = getAppKey();
  if (!key) return null;
  const r = await fetch(`${getApiBase()}/api/state`, {
    method:"POST",
    headers: {"Content-Type":"application/json", "X-App-Key": key},
    body: JSON.stringify(payload)
  });
  if (!r.ok) throw new Error(`D1 POST ${r.status}`);
  return await r.json();
}
function scheduleCloudSave(){
  clearTimeout(cloudTimer);
  if (!getAppKey()) return;
  cloudTimer = setTimeout(async ()=>{
    try{
      const res = await cloudPut({period: state.period, json: state});
      updateDbPill(`guardado ${new Date(res.updated_at||Date.now()).toLocaleTimeString()}`);
    }catch(e){
      dbPill.className = "pill warn";
      dbPill.textContent = "D1: error (llave)";
      console.warn(e);
    }
  }, 900);
}

/* ====== Local ====== */
function loadLocal(period){
  try{
    const raw = localStorage.getItem(keyLocal(period));
    if (!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}
function saveLocal(){
  try{
    state.updated_at = Date.now();
    localStorage.setItem(keyLocal(state.period), JSON.stringify(state));
    savePill.textContent = `Auto-guardado: ${new Date(state.updated_at).toLocaleTimeString()}`;
    lastEditEl.textContent = `Ãšltima ediciÃ³n: ${new Date(state.updated_at).toLocaleString()}`;
  }catch(e){
    showToast("No se pudo guardar local (storage lleno).");
  }
}
function scheduleLocalSave(){
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=> saveLocal(), 200);
}

/* ====== ConstrucciÃ³n ====== */
function emptyPeriod(period){
  const def = DEFAULTS[period] || {deadline:"", fee:0, payMedium:"", receiver:""};
  return {
    period,
    meta: { ...def, services: { items: defaultServices() } },
    rows: UNITS.map(u=>({
      unit:u.unit, floor:u.floor,
      amount_due:Number(def.fee||0),
      amount_paid:0,
      paid_date:"",
      method:"",
      op:"",
      note:""
    })),
    updated_at: Date.now()
  };
}
function ensureRows(){
  const defFee = Number(state.meta.fee||0);
  state.rows = UNITS.map(u=>{
    const old = (state.rows||[]).find(x=>x.unit===u.unit);
    return old ? {...old, unit:u.unit, floor:u.floor} : ({unit:u.unit,floor:u.floor,amount_due:defFee,amount_paid:0,paid_date:"",method:"",op:"",note:""});
  });
  ensureServices(state.meta);
}

/* ====== Render ====== */
function buildQuickUnits(){
  el("quickUnit").innerHTML = `<option value="">Dptoâ€¦</option>` + UNITS.map(u=>`<option value="${u.unit}">${u.unit}</option>`).join("");
}
function renderServices(){
  ensureServices(state.meta);
  const list = el("svcList");
  const items = state.meta.services.items;

  list.innerHTML = items.map(s=>{
    const badgeClass = s.paid ? "ok" : "bad";
    const badgeText = s.paid ? "PAGADO" : "PENDIENTE";
    return `
      <div class="svcItem" data-id="${escapeHtml(s.id)}">
        <div><b>${escapeHtml(s.name)}</b></div>
        <div><input class="svcAmt" type="number" step="0.01" min="0" inputmode="decimal" value="${toNum(s.amount).toFixed(2)}"></div>
        <div><span class="badge ${badgeClass} svcToggle">${badgeText}</span></div>
        <div><input class="svcDate" type="date" value="${escapeHtml(s.paid_date||"")}"></div>
        <div class="note"><input class="svcNote" placeholder="Nota" value="${escapeHtml(s.note||"")}"></div>
        <div class="del">${s.locked ? "" : `<button class="danger svcDel" title="Eliminar">âœ•</button>`}</div>
      </div>
    `;
  }).join("");

  // Totales
  let total = 0, paid = 0, pend = 0;
  for (const s of items){
    const a = Math.max(0, toNum(s.amount));
    total += a;
    if (s.paid) paid += a; else pend += a;
  }
  el("svcTotal").textContent = money(total);
  el("svcPaid").textContent = money(paid);
  el("svcPend").textContent = money(pend);
  el("svcFee").textContent = money(total/20);

  // DelegaciÃ³n eventos
  list.onclick = (ev)=>{
    const row = ev.target.closest(".svcItem");
    if (!row) return;
    const id = row.getAttribute("data-id");
    const svc = state.meta.services.items.find(x=>x.id===id);
    if (!svc) return;

    if (ev.target.classList.contains("svcToggle")){
      svc.paid = !svc.paid;
      if (svc.paid && !svc.paid_date) svc.paid_date = todayISO();
      if (!svc.paid) svc.paid_date = "";
      touch();
      renderServices();
      return;
    }
    if (ev.target.classList.contains("svcDel")){
      state.meta.services.items = state.meta.services.items.filter(x=>x.id!==id);
      touch();
      renderServices();
      return;
    }
  };
  list.oninput = (ev)=>{
    const row = ev.target.closest(".svcItem");
    if (!row) return;
    const id = row.getAttribute("data-id");
    const svc = state.meta.services.items.find(x=>x.id===id);
    if (!svc) return;

    if (ev.target.classList.contains("svcAmt")) svc.amount = toNum(ev.target.value);
    if (ev.target.classList.contains("svcDate")) svc.paid_date = ev.target.value || "";
    if (ev.target.classList.contains("svcNote")) svc.note = ev.target.value || "";
    touchDebounced();
  };
}
function computeAndRender(){
  if (!state) return;

  // KPIs
  let collected = 0, pending = 0, paidCount = 0;
  const pendUnits = [];
  for (const r of state.rows){
    const due = Math.max(0, toNum(r.amount_due));
    const paid = Math.max(0, toNum(r.amount_paid));
    const saldo = Math.max(0, due-paid);
    collected += paid;
    pending += saldo;
    if (due>0 && saldo<=0.009) paidCount++;
    else if (due>0 && saldo>0.009) pendUnits.push(r.unit);
  }
  el("kpiCollected").textContent = money(collected);
  el("kpiPending").textContent = money(pending);
  el("kpiOnTime").textContent = `${paidCount}/20`;
  el("kpiMissingCount").textContent = `${pendUnits.length} dptos`;
  el("kpiMissingList").textContent = pendUnits.length ? pendUnits.join(", ") : "â€”";

  // SemÃ¡foro
  const floorsEl = el("floors");
  floorsEl.innerHTML = "";
  for (let f=1; f<=5; f++){
    const units = UNITS.filter(u=>u.floor===f).map(u=>u.unit);
    const rows = state.rows.filter(r=>units.includes(r.unit));
    const dueSum = rows.reduce((a,r)=>a+Math.max(0,toNum(r.amount_due)),0);
    const saldoSum = rows.reduce((a,r)=>a+Math.max(0,Math.max(0,toNum(r.amount_due)-toNum(r.amount_paid))),0);
    let cls = "bad";
    if (dueSum<=0) cls="warn";
    else if (saldoSum<=0.01) cls="ok";
    else if (saldoSum < dueSum) cls="warn";

    const pend = rows.filter(r=>Math.max(0,toNum(r.amount_due)-toNum(r.amount_paid))>0.009 && toNum(r.amount_due)>0).map(r=>r.unit);
    const card = document.createElement("div");
    card.className = "floorCard";
    card.innerHTML = `
      <div class="floorTitle"><span class="dot ${cls}"></span>Piso ${f} <span class="muted tiny">(${4-pend.length}/4 al dÃ­a)</span></div>
      <div class="floorPend">Pendientes: ${pend.length?pend.join(", "):"â€”"}</div>
    `;
    floorsEl.appendChild(card);
  }

  // Tabla
  const tbody = el("tbody");
  tbody.innerHTML = "";
  for (const r of state.rows){
    const due = Math.max(0, toNum(r.amount_due));
    const paid = Math.max(0, toNum(r.amount_paid));
    const saldo = Math.max(0, due-paid);

    let st="PENDIENTE", cls="bad";
    if (due<=0){ st="SIN MONTO"; cls="warn"; }
    else if (saldo<=0.009){ st="PAGADO"; cls="ok"; }
    else if (paid>0){ st="PARCIAL"; cls="warn"; }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><b>${r.unit}</b></td>
      <td>${r.floor}</td>
      <td><input data-k="amount_due" data-u="${r.unit}" type="number" step="0.01" min="0" inputmode="decimal" value="${due.toFixed(2)}"></td>
      <td><input data-k="amount_paid" data-u="${r.unit}" type="number" step="0.01" min="0" inputmode="decimal" value="${paid.toFixed(2)}"></td>
      <td><span class="mono">${money(saldo)}</span></td>
      <td><input data-k="paid_date" data-u="${r.unit}" type="date" value="${escapeHtml(r.paid_date||"")}"></td>
      <td><input data-k="method" data-u="${r.unit}" value="${escapeHtml(r.method||"")}"></td>
      <td><input data-k="op" data-u="${r.unit}" value="${escapeHtml(r.op||"")}"></td>
      <td><textarea data-k="note" data-u="${r.unit}">${escapeHtml(r.note||"")}</textarea></td>
      <td><span class="statusTxt ${cls}">${st}</span></td>
    `;
    tbody.appendChild(tr);
  }
}

/* ====== Cambios ====== */
function touch(){
  scheduleLocalSave();
  scheduleCloudSave();
}
function touchDebounced(){
  scheduleLocalSave();
  clearTimeout(touchDebounced._t);
  touchDebounced._t = setTimeout(()=> scheduleCloudSave(), 700);
}
function setInputs(){
  el("deadline").value = state.meta.deadline || "";
  el("fee").value = toNum(state.meta.fee).toFixed(2);
  el("payMedium").value = state.meta.payMedium || "";
  el("receiver").value = state.meta.receiver || "";
}
function applyFeeToAllIfChecked(){
  if (!el("chkApplyAll").checked) return;
  const fee = Math.max(0, toNum(state.meta.fee));
  for (const r of state.rows) r.amount_due = fee;
}
async function switchPeriod(period){
  state = loadLocal(period) || emptyPeriod(period);
  state.period = period;
  ensureRows();
  setInputs();
  buildQuickUnits();
  updateDbPill();

  if (getAppKey()){
    try{
      const cloud = await cloudGet(period);
      if (cloud && cloud.json){
        const cloudState = cloud.json;
        const cloudTs = Number(cloudState.updated_at||0);
        const localTs = Number(state.updated_at||0);
        if (cloudTs > localTs){
          state = cloudState;
          ensureRows();
          setInputs();
          showToast("Cargado desde D1.");
        }
        updateDbPill("conectado");
      }
    }catch(e){
      dbPill.className="pill warn";
      dbPill.textContent="D1: error (llave)";
      console.warn(e);
    }
  }

  renderServices();
  computeAndRender();
  saveLocal();
}
function onMetaChange(){
  state.meta.deadline = el("deadline").value || "";
  state.meta.fee = toNum(el("fee").value);
  state.meta.payMedium = el("payMedium").value || "";
  state.meta.receiver = el("receiver").value || "";
  applyFeeToAllIfChecked();
  renderServices();
  computeAndRender();
  touch();
}
function onTableInput(ev){
  const t = ev.target;
  const unit = t.getAttribute("data-u");
  const k = t.getAttribute("data-k");
  if (!unit || !k) return;
  const row = state.rows.find(r=>r.unit===unit);
  if (!row) return;

  if (k==="amount_due" || k==="amount_paid") row[k] = toNum(t.value);
  else row[k] = t.value;

  computeAndRender();
  touchDebounced();
}

/* ====== Acciones ====== */
function markPaidToday(){
  const u = el("quickUnit").value;
  if (!u) return showToast("Elige un dpto.");
  const r = state.rows.find(x=>x.unit===u);
  if (!r) return;
  r.amount_paid = Math.max(0, toNum(r.amount_due));
  r.paid_date = todayISO();
  computeAndRender();
  touch();
  showToast(`${u} marcado pagado.`);
}
function copyMissing(){
  const miss = state.rows.filter(r=>toNum(r.amount_due)>0 && Math.max(0,toNum(r.amount_due)-toNum(r.amount_paid))>0.009).map(r=>r.unit).join(", ") || "â€”";
  navigator.clipboard?.writeText(miss);
  showToast("Pendientes copiados.");
}
function copyMsgByFloors(){
  const lines = [];
  for (let f=1; f<=5; f++){
    const pend = state.rows.filter(r=>r.floor===f && toNum(r.amount_due)>0 && Math.max(0,toNum(r.amount_due)-toNum(r.amount_paid))>0.009).map(r=>r.unit);
    if (pend.length) lines.push(`Piso ${f}: ${pend.join(", ")}`);
  }
  const msg = lines.length ? lines.join("\n") : "Todos al dÃ­a.";
  navigator.clipboard?.writeText(msg);
  showToast("Mensaje por pisos copiado.");
}
function backupJson(){
  const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `block12-cobranzas-${state.period}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if (!obj || !obj.period) throw new Error("JSON invÃ¡lido.");
      state = obj;
      ensureRows();
      setInputs();
      renderServices();
      computeAndRender();
      touch();
      showToast("Importado.");
    }catch(e){ showToast(e.message); }
  };
  reader.readAsText(file);
}
function exportCsv(){
  const headers = ["Periodo","Dpto","Piso","Monto","Pagado","Saldo","Fecha","Medio","Operacion","Nota","Estado"];
  const lines = [headers.join(",")];
  for (const r of state.rows){
    const due = toNum(r.amount_due);
    const paid = toNum(r.amount_paid);
    const saldo = Math.max(0, due-paid);
    let st = "PENDIENTE";
    if (due<=0) st="SIN MONTO";
    else if (saldo<=0.009) st="PAGADO";
    else if (paid>0) st="PARCIAL";
    const row = [state.period,r.unit,r.floor,due.toFixed(2),paid.toFixed(2),saldo.toFixed(2),r.paid_date||"",r.method||"",r.op||"", (r.note||"").replace(/\n/g," "), st]
      .map(x => `"${String(x).replaceAll('"','""')}"`);
    lines.push(row.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `block12-cobranzas-${state.period}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}
function exportPdf(){
  const w = window.open("", "_blank");
  if (!w) return showToast("Tu navegador bloqueÃ³ el PDF (habilita pop-ups).");

  // KPIs directos
  let collected = 0, pending = 0, paidCount = 0;
  const pendUnitsArr = [];
  for (const r of state.rows){
    const due = Math.max(0, toNum(r.amount_due));
    const paid = Math.max(0, toNum(r.amount_paid));
    const saldo = Math.max(0, due-paid);
    collected += paid;
    pending += saldo;
    if (due>0 && saldo<=0.009) paidCount++;
    else if (due>0 && saldo>0.009) pendUnitsArr.push(r.unit);
  }
  const pendingUnits = pendUnitsArr.length ? pendUnitsArr.join(", ") : "â€”";

  const servicesRows = (state.meta.services?.items || []).map(s=>{
    const st = s.paid ? "PAGADO" : "PENDIENTE";
    const cls = s.paid ? "ok" : "bad";
    return `<tr>
      <td><b>${escapeHtml(s.name)}</b></td>
      <td style="text-align:right">${toNum(s.amount).toFixed(2)}</td>
      <td class="${cls}"><b>${st}</b></td>
      <td>${escapeHtml(s.paid_date||"")}</td>
      <td>${escapeHtml(s.note||"")}</td>
    </tr>`;
  }).join("");

  const html = `
  <html><head><meta charset="utf-8">
  <title>Reporte Cobranzas ${state.period}</title>
  <style>
    body{font-family:Calibri,Arial,sans-serif;margin:22px}
    h1{margin:0 0 10px 0;color:#1F4E79}
    .meta{margin:6px 0 14px 0}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #bbb;padding:6px;vertical-align:top}
    th{background:#f3f6ff}
    .kpi{display:flex;gap:12px;margin:10px 0 14px 0;flex-wrap:wrap}
    .box{border:1px solid #bbb;padding:8px;border-radius:8px;min-width:160px}
    .muted{color:#555}
    .bad{color:#b00020}
    .ok{color:#0b6b2f}
    .warn{color:#9a6b00}
  </style></head><body>
    <h1>Control de Cobranzas â€” ${periodLabel(state.period)}</h1>
    <div class="meta">
      <div><b>Fecha lÃ­mite:</b> ${state.meta.deadline || "â€”"}</div>
      <div><b>Cuota por dpto:</b> ${money(state.meta.fee || 0)}</div>
      <div><b>Pago:</b> ${escapeHtml(state.meta.payMedium || "â€”")} ${state.meta.receiver ? "â€” " + escapeHtml(state.meta.receiver) : ""}</div>
      <div class="muted"><b>Pendientes:</b> <span class="bad">${escapeHtml(pendingUnits)}</span></div>
    </div>

    <div class="kpi">
      <div class="box"><div class="muted">Recaudado</div><div><b>${money(collected)}</b></div></div>
      <div class="box"><div class="muted">Pendiente</div><div><b class="bad">${money(pending)}</b></div></div>
      <div class="box"><div class="muted">Al dÃ­a</div><div><b>${paidCount}/20</b></div></div>
      <div class="box"><div class="muted">Dptos pendientes</div><div><b class="bad">${pendUnitsArr.length} dptos</b></div></div>
    </div>

    <h3 style="margin:14px 0 6px 0">Detalle por departamento</h3>
    <table>
      <thead><tr>
        <th>Dpto</th><th>Piso</th><th>Monto</th><th>Pagado</th><th>Saldo</th><th>Fecha</th><th>Medio</th><th>OperaciÃ³n</th><th>Nota</th><th>Estado</th>
      </tr></thead>
      <tbody>
        ${state.rows.map(r=>{
          const due = toNum(r.amount_due);
          const paid = toNum(r.amount_paid);
          const saldo = Math.max(0, due-paid);
          let st="PENDIENTE", cls="bad";
          if (due<=0){ st="SIN MONTO"; cls="warn"; }
          else if (saldo<=0.009){ st="PAGADO"; cls="ok"; }
          else if (paid>0){ st="PARCIAL"; cls="warn"; }
          return `<tr>
            <td><b>${r.unit}</b></td>
            <td>${r.floor}</td>
            <td style="text-align:right">${due.toFixed(2)}</td>
            <td style="text-align:right">${paid.toFixed(2)}</td>
            <td style="text-align:right">${saldo.toFixed(2)}</td>
            <td>${escapeHtml(r.paid_date||"")}</td>
            <td>${escapeHtml(r.method||"")}</td>
            <td>${escapeHtml(r.op||"")}</td>
            <td>${escapeHtml(r.note||"")}</td>
            <td class="${cls}"><b>${st}</b></td>
          </tr>`;
        }).join("")}
      </tbody>
    </table>

    <h3 style="margin:14px 0 6px 0">Control de pagos de servicios</h3>
    <table>
      <thead><tr><th>Servicio</th><th>Monto</th><th>Estado</th><th>Fecha</th><th>Nota</th></tr></thead>
      <tbody>${servicesRows || `<tr><td colspan="5" class="muted">Sin servicios registrados.</td></tr>`}</tbody>
    </table>

    <p class="muted" style="margin-top:12px">Generado: ${new Date().toLocaleString()}</p>
  </body></html>`;

  w.document.open();
  w.document.write(html);
  w.document.close();
  setTimeout(()=>{ try{ w.focus(); w.print(); }catch(e){} }, 250);
}
async function configureKey(){
  const current = getAppKey();
  const k = prompt("Pega tu APP_KEY para guardar/leer en D1 (se guarda en este navegador).", current || "");
  if (k === null) return;
  const kk = String(k).trim();
  setAppKey(kk);

  if (!kk){
    showToast("Llave quitada. Se guardarÃ¡ solo local.");
    return;
  }
  try{
    const got = await cloudGet(state?.period || el("period").value);
    updateDbPill("conectado");
    showToast("D1 conectado.");
    if (got && got.json){
      const cloudTs = Number(got.json.updated_at||0);
      const localTs = Number(state?.updated_at||0);
      if (cloudTs > localTs){
        state = got.json;
        ensureRows();
        setInputs();
        renderServices();
        computeAndRender();
        saveLocal();
        showToast("Cargado desde D1.");
      }
    }
  }catch(e){
    dbPill.className="pill warn";
    dbPill.textContent="D1: llave invÃ¡lida";
    showToast("No conectÃ³. Revisa APP_KEY.");
    console.warn(e);
  }
}

/* ====== Eventos ====== */
function wire(){
  el("period").addEventListener("change", ()=> switchPeriod(el("period").value));
  el("deadline").addEventListener("change", onMetaChange);
  el("fee").addEventListener("input", onMetaChange);
  el("payMedium").addEventListener("input", onMetaChange);
  el("receiver").addEventListener("input", onMetaChange);

  el("tbody").addEventListener("input", onTableInput);
  el("tbody").addEventListener("change", onTableInput);

  el("btnPdf").addEventListener("click", exportPdf);
  el("btnCsv").addEventListener("click", exportCsv);

  el("btnBackup").addEventListener("click", backupJson);
  el("btnImport").addEventListener("click", ()=> el("fileImport").click());
  el("fileImport").addEventListener("change", (e)=> e.target.files?.[0] && importJsonFile(e.target.files[0]));

  el("btnCopyMissing").addEventListener("click", copyMissing);
  el("btnCopyMsg").addEventListener("click", copyMsgByFloors);
  el("btnMarkPaid").addEventListener("click", markPaidToday);

  el("btnUseFee").addEventListener("click", ()=>{
    const items = state.meta.services.items || [];
    const total = items.reduce((a,s)=>a+Math.max(0,toNum(s.amount)),0);
    const fee = total/20;
    state.meta.fee = fee;
    el("fee").value = fee.toFixed(2);
    applyFeeToAllIfChecked();
    computeAndRender();
    touch();
    showToast("Cuota aplicada.");
  });

  el("btnAddSvc").addEventListener("click", ()=>{
    const name = (el("newSvcName").value||"").trim();
    const amt = toNum(el("newSvcAmt").value);
    if (!name) return showToast("Escribe el nombre del servicio.");
    state.meta.services.items.push({id: uid(), name, amount: amt, paid:false, paid_date:"", note:"", locked:false});
    el("newSvcName").value = "";
    el("newSvcAmt").value = "";
    renderServices();
    touch();
    showToast("Servicio agregado.");
  });

  el("btnKey").addEventListener("click", configureKey);
}

/* ====== Init ====== */
(async function init(){
  wire();
  buildQuickUnits();
  updateDbPill();
  await switchPeriod(el("period").value);
  showToast("Listo. 20 dptos cargados.");
})();
</script>
</body>
</html>
