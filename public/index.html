<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Block 12 ‚Äî Cobranzas (Feb‚ÄìJun 2026)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --panel:#0a1430;
      --muted:#8aa0c6;
      --txt:#e7efff;
      --ok:#1db954;
      --warn:#f5c542;
      --bad:#ff4d4d;
      --line:rgba(255,255,255,.10);
      --shadow:0 14px 40px rgba(0,0,0,.28);
      --radius:16px;
      --gap:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:radial-gradient(1200px 600px at 20% -10%, rgba(27,58,166,.25), transparent 60%),
                 radial-gradient(900px 520px at 100% 0%, rgba(29,185,84,.10), transparent 55%),
                 linear-gradient(180deg,#071028,#0b1020);
      color:var(--txt);
    }
    .wrap{max-width:1280px;margin:0 auto;padding:18px 14px}
    header{
      position:sticky;top:0;z-index:20;
      background:rgba(11,16,32,.86);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    h1{font-size:18px;letter-spacing:.2px;margin:0 0 6px 0}
    .subrow{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      padding:7px 10px;border-radius:999px;
      font-size:12px;border:1px solid var(--line);
      color:var(--muted);background:rgba(255,255,255,.03)
    }
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(18,34,82,.85);
      color:var(--txt);
      cursor:pointer;
      transition:transform .05s ease, filter .15s ease;
      white-space:nowrap;
    }
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    button.primary{background:#1b3aa6;border-color:rgba(255,255,255,.18)}
    button.danger{background:#7a1f2a}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    select,input,textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(10,20,48,.92);
      color:var(--txt);
      outline:none;
    }
    input.num{max-width:120px}
    input.date{max-width:160px}
    input.txt{min-width:140px}
    textarea.note{min-height:40px;resize:vertical}
    .card{
      background:rgba(17,26,51,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .stack{
      display:flex;
      flex-direction:column;
      gap:var(--gap);
      align-items:stretch;
    }
    .topInner{
      display:grid;
      grid-template-columns:repeat(12,minmax(0,1fr));
      gap:var(--gap);
    }
    .topInner .col4{grid-column:span 4;}

    .section{
      padding:12px;
      border-radius:14px;
      background:rgba(10,20,48,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .section + .section{margin-top:12px}
    .sectionTitle{
      font-size:12px;
      color:var(--muted);
      letter-spacing:.3px;
      text-transform:uppercase;
      margin:0 0 10px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .form3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .form2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .kpi .box{
      background:rgba(10,20,48,.92);
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      padding:12px;
      min-height:102px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .big{font-size:22px;font-weight:800;margin-top:6px;letter-spacing:.2px}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .muted{color:var(--muted)}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btnbar > *{flex:0 0 auto}
    .chiplist{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      max-height:78px;
      overflow:auto;
      margin-top:8px;
      padding-right:2px;
    }
    .chip{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
    }
    .rightTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    #byFloor{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    .floorCard{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(10,20,48,.92);
      min-height:84px;
      display:flex;
      align-items:center;
    }
    .floorTitle{font-weight:800}
    .floorPend{margin-top:6px;font-size:12px}
    .status{font-weight:800}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .tableWrap{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      overflow:auto;
      background:rgba(10,20,48,.55);
    }
    table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
    th,td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{
      font-size:12px;
      color:var(--muted);
      text-align:left;
      position:sticky;
      top:0;
      background:rgba(10,20,48,.96);
      backdrop-filter:blur(6px);
      z-index:2;
    }
    tr:last-child td{border-bottom:none}
    .footer-note{font-size:12px;color:var(--muted);margin-top:10px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;z-index:50;
      background:rgba(10,20,48,.96);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius:14px;
      display:none;
      max-width:min(620px,92vw);
      box-shadow:0 18px 50px rgba(0,0,0,.35);
    }
    .toast.show{display:block}
    /* Responsive */
    @media (max-width: 1180px){
      .topInner .col4{grid-column:span 6}
      #byFloor{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    @media (max-width: 980px){
      .topInner .col4{grid-column:span 12}
      .form3{grid-template-columns:1fr}
      .form2{grid-template-columns:1fr}
      #byFloor{grid-template-columns:repeat(2,minmax(0,1fr))}
      table{min-width:0}
    }
    @media (max-width: 860px){
      /* Mobile table -> cards */
      table, thead, tbody, th, td, tr { display:block; }
      thead{display:none}
      .tableWrap{background:transparent;border:0}
      tr{
        border:1px solid rgba(255,255,255,.10);
        border-radius:14px;
        margin:10px 0;
        background:rgba(10,20,48,.92);
        overflow:hidden;
      }
      td{border-bottom:1px solid rgba(255,255,255,.08)}
      td:last-child{border-bottom:none}
      td[data-label]::before{
        content:attr(data-label);
        display:block;
        font-size:12px;
        color:var(--muted);
        margin-bottom:4px
      }
      input.num,input.date{max-width:100%}
    }
  
    @media (max-width: 560px){
      #byFloor{grid-template-columns:1fr}
    }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div>
          <h1>Block 12 ‚Äî Control de Cobranzas (Feb‚ÄìJun 2026)</h1>
          <div class="subrow">
            <span class="pill" id="savePill">Auto-guardado local: ‚Äî</span>
            <span class="pill" id="cloudPill">Nube: ‚Äî</span>
          </div>
        </div>
        <div class="actions">
          <button class="primary" id="btnPdf">Exportar PDF</button>
          <button id="btnCsv">Exportar CSV</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="stack">

      <!-- Izquierda -->
      <section class="card">
        <div class="topInner">
        <div class="section col4">
          <div class="sectionTitle">Configuraci√≥n del mes</div>
          <div class="form3">
            <div>
              <label>Mes</label>
              <select id="period">
                <option value="2026-02">Febrero 2026</option>
                <option value="2026-03">Marzo 2026</option>
                <option value="2026-04">Abril 2026</option>
                <option value="2026-05">Mayo 2026</option>
                <option value="2026-06">Junio 2026</option>
              </select>
            </div>
            <div>
              <label>Fecha l√≠mite</label>
              <input id="deadline" type="date" />
            </div>
            <div>
              <label>Cuota base por dpto (S/)</label>
              <input id="fee" type="number" step="0.01" min="0" inputmode="decimal" />
            </div>
          </div>

          <div class="form2" style="margin-top:10px">
            <div>
              <label>Medio de pago (texto para mostrar)</label>
              <input id="payMedium" placeholder="Ej: PLIN 978 515 968" />
            </div>
            <div>
              <label>Recepciona</label>
              <input id="receiver" placeholder="Ej: William Huatay Villoslada" />
            </div>
          </div>
        </div>

        <div class="section col4">
          <div class="sectionTitle">Resumen del mes</div>
          <div class="kpi">
            <div class="box">
              <div class="small">Recaudado</div>
              <div class="big" id="kpiCollected">S/ 0.00</div>
            </div>
            <div class="box">
              <div class="small">Pendiente</div>
              <div class="big" id="kpiPending">S/ 0.00</div>
            </div>
            <div class="box">
              <div class="small">Al d√≠a</div>
              <div class="big" id="kpiPaid">0/20</div>
            </div>
            <div class="box">
              <div class="small">Dptos pendientes</div>
              <div class="big"><span id="kpiMissingCount">0</span><span class="small" style="margin-left:6px">dptos</span></div>
              <div class="chiplist" id="kpiMissingChips"></div>
              <div id="kpiMissingAll" style="display:none"></div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:12px">
            <button id="btnMarkPaid">Marcar Pagado (hoy)</button>
            <select id="quickUnit" style="min-width:140px;max-width:180px"><option value="">Dpto‚Ä¶</option></select>
            <button id="btnCopyMissing">Copiar pendientes</button>
            <button id="btnCopyMsg">Copiar mensaje por pisos</button>
          </div>
        </div>

        <div class="section col4">
          <div class="sectionTitle">Nube y respaldo</div>

          <div class="form2">
            <div>
              <label>API base (Pages)</label>
              <input id="apiBase" placeholder="Ej: https://block12-cobranzas.pages.dev" />
              <div class="footer-note">Tip: se guarda en este navegador (localStorage).</div>
            </div>
            <div>
              <label>Clave de nube (APP_KEY)</label>
              <input id="appKey" type="password" placeholder="Pega tu APP_KEY" />
              <div class="footer-note">Se guarda solo en esta sesi√≥n (sessionStorage).</div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:10px">
            <button id="btnCloudPull">Traer de nube</button>
            <button class="primary" id="btnCloudPush">Subir a nube</button>
          </div>

          <div class="divider"></div>

          <div class="btnbar">
            <button id="btnBackup">Backup JSON</button>
            <button id="btnImport">Importar JSON</button>
            <input id="fileImport" type="file" accept="application/json" style="display:none" />
            <button id="btnCopyCode">Copiar c√≥digo respaldo</button>
            <button class="danger" id="btnRestoreCode">Restaurar c√≥digo</button>
          </div>

          <div class="footer-note">Regla de oro: nube + backup mensual. El √∫nico ‚Äúsin riesgo‚Äù es el que nunca se usa.</div>
        </div>
        </div>

      </section>

      <!-- Derecha -->
      <section class="card">
        <div class="rightTop">
          <div>
            <div class="small">Sem√°foro por piso (4 dptos por piso)</div>
            <div id="byFloor"></div>
          </div>
          <div style="text-align:right">
            <div class="small">√öltima edici√≥n</div>
            <div class="mono" id="lastEdit">‚Äî</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="small">Detalle por departamento</div>
        <div class="tableWrap">
          <table id="tbl">
            <thead>
              <tr>
                <th style="width:70px">Dpto</th>
                <th style="width:60px">Piso</th>
                <th style="width:120px">Monto</th>
                <th style="width:120px">Pagado</th>
                <th style="width:110px">Saldo</th>
                <th style="width:160px">Fecha</th>
                <th style="width:180px">Medio</th>
                <th style="width:160px">Operaci√≥n</th>
                <th>Nota</th>
                <th style="width:120px">Estado</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>

    </div>
  </main>

  <div class="toast" id="toast"></div>

<script>
const UNITS = (() => {
  const arr = [];
  for (let floor=1; floor<=5; floor++){
    for (let i=1; i<=4; i++){
      arr.push({unit: `${floor}0${i}`, floor});
    }
  }
  return arr;
})();

const DEFAULTS = {
  "2026-02": { deadline: "2026-02-19", fee: 114.82, payMedium:"PLIN 978 515 968", receiver:"William Huatay Villoslada" },
  "2026-03": { deadline: "2026-03-19", fee: 0, payMedium:"", receiver:"" },
  "2026-04": { deadline: "2026-04-19", fee: 0, payMedium:"", receiver:"" },
  "2026-05": { deadline: "2026-05-19", fee: 0, payMedium:"", receiver:"" },
  "2026-06": { deadline: "2026-06-19", fee: 0, payMedium:"", receiver:"" },
};

function emptyPeriod(period){
  const def = DEFAULTS[period] || {deadline:"", fee:0, payMedium:"", receiver:""};
  return {
    period,
    meta: { ...def },
    rows: UNITS.map(u => ({
      unit: u.unit,
      floor: u.floor,
      amount_due: Number(def.fee||0),
      amount_paid: 0,
      paid_date: "",
      method: "",
      op: "",
      note: ""
    })),
    updated_at: Date.now()
  };
}

function keyLocal(period){ return `block12:cobranzas:${period}`; }

let state = null;
let autosaveTimer = null;
let cloudAutosyncTimer = null;

const el = (id)=>document.getElementById(id);
const periodSel = el("period");
const deadlineInp = el("deadline");
const feeInp = el("fee");
const payMediumInp = el("payMedium");
const receiverInp = el("receiver");
const tbody = el("tbody");
const savePill = el("savePill");
const cloudPill = el("cloudPill");
const lastEdit = el("lastEdit");
const quickUnit = el("quickUnit");
const toast = el("toast");
const apiBaseInp = el("apiBase");
const appKeyInp = el("appKey");

function money(n){ return `S/ ${Number(n||0).toFixed(2)}`; }
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add("show");
  setTimeout(()=>toast.classList.remove("show"), 2200);
}

function loadLocal(period){
  const raw = localStorage.getItem(keyLocal(period));
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function saveLocal(){
  if (!state) return;
  state.updated_at = Date.now();
  localStorage.setItem(keyLocal(state.period), JSON.stringify(state));
  savePill.textContent = `Auto-guardado local: ${new Date(state.updated_at).toLocaleString()}`;
  lastEdit.textContent = new Date(state.updated_at).toLocaleString();
}

function scheduleSave(){
  clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(()=>{
    saveLocal();
    computeAndRender();
    scheduleCloudAutosync();
  }, 250);
}

function getAppKey(){
  const v = appKeyInp.value.trim();
  if (v) sessionStorage.setItem("block12:appkey", v);
  return (v || sessionStorage.getItem("block12:appkey") || "").trim();
}

function getApiBase(){
  const v = apiBaseInp.value.trim().replace(/\/+$/,"");
  if (v) localStorage.setItem("block12:apibase", v);
  return (v || localStorage.getItem("block12:apibase") || "").trim().replace(/\/+$/,"");
}

async function cloudGet(period){
  const base = getApiBase();
  const key = getAppKey();
  if (!base) throw new Error("Falta API base");
  if (!key) throw new Error("Falta APP_KEY");
  const r = await fetch(`${base}/api/state?period=${encodeURIComponent(period)}`, {
    headers: { "X-App-Key": key }
  });
  if (!r.ok) throw new Error(`Nube GET error ${r.status}`);
  return await r.json();
}

async function cloudPut(payload){
  const base = getApiBase();
  const key = getAppKey();
  if (!base) throw new Error("Falta API base");
  if (!key) throw new Error("Falta APP_KEY");
  const r = await fetch(`${base}/api/state`, {
    method: "POST",
    headers: { "Content-Type":"application/json", "X-App-Key": key },
    body: JSON.stringify(payload)
  });
  if (!r.ok) throw new Error(`Nube POST error ${r.status}`);
  return await r.json();
}

function scheduleCloudAutosync(){
  clearTimeout(cloudAutosyncTimer);
  const base = getApiBase();
  const key = getAppKey();
  if (!base || !key) return;
  cloudAutosyncTimer = setTimeout(async ()=>{
    try{
      const res = await cloudPut({period: state.period, json: state});
      cloudPill.textContent = `Nube: guardado ${new Date(res.updated_at).toLocaleString()}`;
    }catch(e){
      cloudPill.textContent = `Nube: error (ver clave/base)`;
    }
  }, 900);
}

function setInputs(){
  deadlineInp.value = state.meta.deadline || "";
  feeInp.value = Number(state.meta.fee || 0).toFixed(2);
  payMediumInp.value = state.meta.payMedium || "";
  receiverInp.value = state.meta.receiver || "";
  apiBaseInp.value = getApiBase();
  appKeyInp.value = sessionStorage.getItem("block12:appkey") || "";
}

function buildQuickUnits(){
  quickUnit.innerHTML = `<option value="">Dpto‚Ä¶</option>` + UNITS.map(u=>`<option value="${u.unit}">${u.unit}</option>`).join("");
}

function computeAndRender(){
  if (!state) return;

  // Helpers
  const toNum = (v)=> {
    const n = Number(v);
    return (Number.isFinite(n) ? n : 0);
  };

  let collected = 0, pending = 0, paidCount = 0;

  for (const r of state.rows){
    const due = Math.max(0, toNum(r.amount_due));
    const paid = Math.max(0, toNum(r.amount_paid));
    const saldo = Math.max(0, due - paid);

    collected += paid;
    pending += saldo;

    if (due > 0 && saldo <= 0.009) paidCount++;
  }

  // Avoid -0.00 glitches
  collected = Math.max(0, collected);
  pending = Math.max(0, pending);

  el("kpiCollected").textContent = money(collected);
  el("kpiPending").textContent = money(pending);
  el("kpiPaid").textContent = `${paidCount}/20`;

  const missingArr = state.rows
    .filter(r => toNum(r.amount_due) > 0 && Math.max(0, toNum(r.amount_due) - toNum(r.amount_paid)) > 0.009)
    .map(r => r.unit);

  // Count + chips (compact, no ‚Äúlista infinita‚Äù que rompe la simetr√≠a)
  const missCountEl = el("kpiMissingCount");
  const missChipsEl = el("kpiMissingChips");
  const missAllEl = el("kpiMissingAll");

  missCountEl.textContent = `${missingArr.length}`;
  missChipsEl.innerHTML = missingArr.length
    ? missingArr.map(u => `<span class="chip">${u}</span>`).join("")
    : `<span class="muted">‚Äî</span>`;

  missChipsEl.dataset.all = missingArr.join(", ");
  missAllEl.textContent = missingArr.length ? missingArr.join(", ") : "‚Äî";

  // Sem√°foro por piso (en grid para que se vea ‚Äúcuadradito‚Äù)
  const floors = {1:[],2:[],3:[],4:[],5:[]};
  for (const r of state.rows) floors[r.floor].push(r);

  el("byFloor").innerHTML = Object.keys(floors).map(f=>{
    const rows = floors[f];
    const paid = rows.filter(x => toNum(x.amount_due) > 0 && Math.max(0, toNum(x.amount_due) - toNum(x.amount_paid)) <= 0.009).length;

    const status = paid===4 ? "ok" : paid===3 ? "warn" : "bad";
    const dot = paid===4 ? "üü¢" : paid===3 ? "üü°" : "üî¥";
    const pend = rows
      .filter(x => toNum(x.amount_due) > 0 && Math.max(0, toNum(x.amount_due) - toNum(x.amount_paid)) > 0.009)
      .map(x => x.unit);

    const pendText = pend.length ? pend.join(", ") : "‚Äî";

    return `
      <div class="floorCard">
        <div class="floorLeft">
          <div class="floorTitle"><span class="status ${status}">${dot} Piso ${f}</span> <span class="muted">(${paid}/4 al d√≠a)</span></div>
          <div class="floorPend muted">Pendientes: ${pendText}</div>
        </div>
      </div>`;
  }).join("");

  // Tabla
  tbody.innerHTML = "";
  for (const r of state.rows){
    const due = Math.max(0, toNum(r.amount_due));
    const paid = Math.max(0, toNum(r.amount_paid));
    const saldo = Math.max(0, due - paid);

    let st = "PENDIENTE", cls = "bad";
    if (due<=0){ st="SIN MONTO"; cls="warn"; }
    else if (saldo<=0.009){ st="PAGADO"; cls="ok"; }
    else if (paid>0){ st="PARCIAL"; cls="warn"; }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="Dpto"><strong>${r.unit}</strong></td>
      <td data-label="Piso">${r.floor}</td>
      <td data-label="Monto (S/)"><input class="num" data-k="amount_due" data-u="${r.unit}" type="number" step="0.01" min="0" inputmode="decimal" value="${due.toFixed(2)}"></td>
      <td data-label="Pagado (S/)"><input class="num" data-k="amount_paid" data-u="${r.unit}" type="number" step="0.01" min="0" inputmode="decimal" value="${paid.toFixed(2)}"></td>
      <td data-label="Saldo"><span class="mono">${money(saldo)}</span></td>
      <td data-label="Fecha"><input class="date" data-k="paid_date" data-u="${r.unit}" type="date" value="${r.paid_date||""}"></td>
      <td data-label="Medio"><input class="txt" data-k="method" data-u="${r.unit}" value="${escapeHtml(r.method||"")}"></td>
      <td data-label="Operaci√≥n"><input class="txt" data-k="op" data-u="${r.unit}" value="${escapeHtml(r.op||"")}"></td>
      <td data-label="Nota"><textarea class="note" data-k="note" data-u="${r.unit}">${escapeHtml(r.note||"")}</textarea></td>
      <td data-label="Estado"><span class="status ${cls}">${st}</span></td>
    `;
    tbody.appendChild(tr);
  }
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function updateMetaFromInputs(){
  state.meta.deadline = deadlineInp.value;
  state.meta.fee = Number(feeInp.value || 0);
  state.meta.payMedium = payMediumInp.value.trim();
  state.meta.receiver = receiverInp.value.trim();
}

function findRow(unit){ return state.rows.find(x=>x.unit===unit); }

function onTableInput(e){
  const t = e.target;
  const k = t.getAttribute("data-k");
  const u = t.getAttribute("data-u");
  if (!k || !u) return;
  const r = findRow(u);
  if (!r) return;

  if (k==="amount_due" || k==="amount_paid"){
    // Sanitiza: nada de negativos ni NaN (evita recaudado raro y ‚Äú-‚Äù)
    let v = parseFloat(String(t.value ?? "").replace(",", "."));
    if (!Number.isFinite(v) || Number.isNaN(v)) v = 0;
    if (v < 0) v = 0;
    r[k] = v;
  } else {
    r[k] = t.value;
  }
  scheduleSave();
}

async function switchPeriod(period){
  const local = loadLocal(period);
  state = local || emptyPeriod(period);
  state.rows = UNITS.map(u=>{
    const old = (state.rows||[]).find(x=>x.unit===u.unit);
    return old ? {...old, floor:u.floor, unit:u.unit} : ({unit:u.unit,floor:u.floor,amount_due:Number(state.meta.fee||0),amount_paid:0,paid_date:"",method:"",op:"",note:""});
  });
  setInputs();
  buildQuickUnits();
  computeAndRender();
  saveLocal();
  cloudPill.textContent = "Nube: ‚Äî";
}

function exportCsv(){
  const headers = ["Periodo","Dpto","Piso","Monto","Pagado","Saldo","Fecha","Medio","Operacion","Nota","Estado"];
  const lines = [headers.join(",")];
  for (const r of state.rows){
    const due = Number(r.amount_due||0);
    const paid = Number(r.amount_paid||0);
    const saldo = Math.max(0, due - paid);
    let st = "PENDIENTE";
    if (due<=0) st="SIN MONTO";
    else if (saldo<=0.009) st="PAGADO";
    else if (paid>0) st="PARCIAL";
    const row = [
      state.period, r.unit, r.floor,
      due.toFixed(2), paid.toFixed(2), saldo.toFixed(2),
      r.paid_date||"", q(r.method||""), q(r.op||""), q(r.note||""), st
    ];
    lines.push(row.join(","));
  }
  const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `block12_cobranzas_${state.period}.csv`;
  a.click();
}
function q(s){
  const x = String(s ?? "");
  if (/[",\n]/.test(x)) return '"' + x.replace(/"/g,'""') + '"';
  return x;
}

function backupJson(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `block12_cobranzas_${state.period}.json`;
  a.click();
  showToast("Backup JSON descargado.");
}

function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const obj = JSON.parse(reader.result);
      if (!obj || !obj.period || !obj.rows) throw new Error("JSON inv√°lido");
      state = obj;
      periodSel.value = state.period;
      setInputs();
      computeAndRender();
      saveLocal();
      showToast("Importaci√≥n OK.");
    }catch(e){
      showToast("No se pudo importar: " + e.message);
    }
  };
  reader.readAsText(file);
}

function copyMissing(){
  const chips = el("kpiMissingChips");
  const all = (chips?.dataset?.all || "").trim();
  navigator.clipboard.writeText(all);
  showToast(all ? "Pendientes copiados." : "No hay pendientes.");
}

function periodLabel(p){
  const [y,m]=p.split("-");
  const map={ "02":"FEB","03":"MAR","04":"ABR","05":"MAY","06":"JUN" };
  return `${map[m] || m} ${y}`;
}

function copyMsgByFloors(){
  const floors = {1:[],2:[],3:[],4:[],5:[]};
  for (const r of state.rows) floors[r.floor].push(r);
  let msg = `üìå Control de Cobranza ${periodLabel(state.period)}\n`;
  for (let f=1; f<=5; f++){
    const rows = floors[f];
    const paid = rows.filter(x=>Math.max(0,(x.amount_due||0)-(x.amount_paid||0))<=0.009 && (x.amount_due||0)>0).length;
    const emoji = paid===4 ? "üü¢" : paid===3 ? "üü°" : "üî¥";
    const pend = rows.filter(x=>Math.max(0,(x.amount_due||0)-(x.amount_paid||0))>0.009 && (x.amount_due||0)>0).map(x=>x.unit).join(", ") || "‚Äî";
    msg += `${emoji} Piso ${f}: ${paid}/4 al d√≠a (pendientes: ${pend})\n`;
  }
  msg += `\nPago: ${state.meta.payMedium || "‚Äî"} ‚Äî ${state.meta.receiver || ""}\n`;
  msg += `Fecha l√≠mite: ${state.meta.deadline || "‚Äî"}\n`;
  navigator.clipboard.writeText(msg);
  showToast("Mensaje por pisos copiado.");
}

function copyCode(){
  const code = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
  navigator.clipboard.writeText(code);
  showToast("C√≥digo copiado.");
}

function restoreCode(){
  const code = prompt("Pega aqu√≠ el c√≥digo de respaldo:");
  if (!code) return;
  try{
    const json = decodeURIComponent(escape(atob(code.trim())));
    const obj = JSON.parse(json);
    if (!obj || !obj.period || !obj.rows) throw new Error("Formato inv√°lido");
    state = obj;
    periodSel.value = state.period;
    setInputs();
    computeAndRender();
    saveLocal();
    showToast("Restauraci√≥n OK.");
  }catch(e){
    showToast("No se pudo restaurar: " + e.message);
  }
}

function markPaidToday(){
  const u = quickUnit.value;
  if (!u) return showToast("Selecciona dpto.");
  const r = findRow(u);
  if (!r) return;
  if ((r.amount_due||0) <= 0) return showToast("Primero define monto.");
  r.amount_paid = Number(r.amount_due||0);
  r.paid_date = new Date().toISOString().slice(0,10);
  scheduleSave();
  showToast(`${u} marcado pagado.`);
}

async function cloudPull(){
  try{
    const data = await cloudGet(state.period);
    if (!data || !data.json) return showToast("Nube sin datos para este mes.");
    const cloudTs = data.updated_at || 0;
    const localTs = state.updated_at || 0;
    if (cloudTs > localTs){
      state = data.json;
      periodSel.value = state.period;
      setInputs();
      computeAndRender();
      saveLocal();
      cloudPill.textContent = `Nube: cargado ${new Date(cloudTs).toLocaleString()}`;
      showToast("Tra√≠do de nube.");
    } else {
      cloudPill.textContent = `Nube: ya estabas al d√≠a`;
      showToast("Tu local ya era igual o m√°s reciente.");
    }
  }catch(e){
    cloudPill.textContent = `Nube: error`;
    showToast(e.message);
  }
}

async function cloudPush(){
  try{
    const res = await cloudPut({period: state.period, json: state});
    cloudPill.textContent = `Nube: guardado ${new Date(res.updated_at).toLocaleString()}`;
    showToast("Subido a nube.");
  }catch(e){
    cloudPill.textContent = `Nube: error`;
    showToast(e.message);
  }
}

function exportPdf(){
  const w = window.open("", "_blank");
  const missing = state.rows.filter(r => (r.amount_due||0)>0 && Math.max(0,(r.amount_due||0)-(r.amount_paid||0))>0.009).map(r=>r.unit).join(", ") || "‚Äî";
  const html = `
  <html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Reporte Cobranzas ${state.period}</title>
  <style>
    body{font-family:Calibri,Arial,sans-serif;margin:24px}
    h1{margin:0 0 10px 0;color:#1F4E79}
    .meta{margin:6px 0 14px 0}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #bbb;padding:6px;vertical-align:top}
    th{background:#f3f6ff}
    .kpi{display:flex;gap:12px;margin:10px 0 14px 0;flex-wrap:wrap}
    .box{border:1px solid #bbb;padding:8px;border-radius:8px;min-width:160px}
    .muted{color:#555}
  </style>
  </head><body>
    <h1>Control de Cobranzas ‚Äî ${periodLabel(state.period)}</h1>
    <div class="meta">
      <div><b>Fecha l√≠mite:</b> ${state.meta.deadline || "‚Äî"}</div>
      <div><b>Cuota base:</b> ${money(state.meta.fee || 0)}</div>
      <div><b>Pago:</b> ${(state.meta.payMedium || "‚Äî")} ${(state.meta.receiver ? "‚Äî " + state.meta.receiver : "")}</div>
    </div>
    <div class="kpi">
      <div class="box"><div class="muted">Recaudado</div><div><b>${el("kpiCollected").textContent}</b></div></div>
      <div class="box"><div class="muted">Pendiente</div><div><b>${el("kpiPending").textContent}</b></div></div>
      <div class="box"><div class="muted">Al d√≠a</div><div><b>${el("kpiPaid").textContent}</b></div></div>
      <div class="box"><div class="muted">Pendientes</div><div><b>${missing}</b></div></div>
    </div>
    <table>
      <thead><tr>
        <th>Dpto</th><th>Piso</th><th>Monto</th><th>Pagado</th><th>Saldo</th><th>Fecha</th><th>Medio</th><th>Operaci√≥n</th><th>Nota</th><th>Estado</th>
      </tr></thead>
      <tbody>
        ${state.rows.map(r=>{
          const due = Number(r.amount_due||0);
          const paid = Number(r.amount_paid||0);
          const saldo = Math.max(0, due-paid);
          let st = "PENDIENTE";
          if (due<=0) st="SIN MONTO";
          else if (saldo<=0.009) st="PAGADO";
          else if (paid>0) st="PARCIAL";
          return `<tr>
            <td><b>${r.unit}</b></td>
            <td>${r.floor}</td>
            <td>${due.toFixed(2)}</td>
            <td>${paid.toFixed(2)}</td>
            <td>${saldo.toFixed(2)}</td>
            <td>${r.paid_date||""}</td>
            <td>${(r.method||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
            <td>${(r.op||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
            <td>${(r.note||"").replace(/</g,"&lt;").replace(/>/g,"&gt;")}</td>
            <td><b>${st}</b></td>
          </tr>`;
        }).join("")}
      </tbody>
    </table>
    <p class="muted" style="margin-top:12px">Generado: ${new Date().toLocaleString()}</p>
    <script>window.onload=()=>window.print();<\/script>
  </body></html>`;
  w.document.write(html);
  w.document.close();
}

periodSel.addEventListener("change", ()=> switchPeriod(periodSel.value));
deadlineInp.addEventListener("input", ()=>{ updateMetaFromInputs(); scheduleSave(); });
feeInp.addEventListener("input", ()=>{ updateMetaFromInputs(); scheduleSave(); });
payMediumInp.addEventListener("input", ()=>{ updateMetaFromInputs(); scheduleSave(); });
receiverInp.addEventListener("input", ()=>{ updateMetaFromInputs(); scheduleSave(); });

el("tbl").addEventListener("input", onTableInput);
el("tbl").addEventListener("change", onTableInput);

el("btnPdf").addEventListener("click", exportPdf);
el("btnCsv").addEventListener("click", exportCsv);
el("btnBackup").addEventListener("click", backupJson);
el("btnImport").addEventListener("click", ()=> el("fileImport").click());
el("fileImport").addEventListener("change", (e)=> e.target.files?.[0] && importJsonFile(e.target.files[0]));
el("btnCopyMissing").addEventListener("click", copyMissing);
el("btnCopyMsg").addEventListener("click", copyMsgByFloors);
el("btnCopyCode").addEventListener("click", copyCode);
el("btnRestoreCode").addEventListener("click", restoreCode);
el("btnMarkPaid").addEventListener("click", markPaidToday);

el("btnCloudPull").addEventListener("click", cloudPull);
el("btnCloudPush").addEventListener("click", cloudPush);
apiBaseInp.addEventListener("change", ()=>{ localStorage.setItem("block12:apibase", getApiBase()); showToast("API base guardada."); });
appKeyInp.addEventListener("change", ()=>{ sessionStorage.setItem("block12:appkey", getAppKey()); showToast("Clave guardada (solo esta sesi√≥n)."); });

(async function init(){
  buildQuickUnits();
  const base = localStorage.getItem("block12:apibase") || "";
  if (base) apiBaseInp.value = base;
  await switchPeriod(periodSel.value);
  showToast("Listo. Auto-guardado local activo.");
})();
</script>
</body>
</html>
